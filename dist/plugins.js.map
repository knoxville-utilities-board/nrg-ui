{"version":3,"file":"plugins.js","sources":["../src/plugins.ts"],"sourcesContent":["import { Transformer } from 'content-tag-utils';\nimport { builders, parse, print } from 'ember-template-recast';\nimport { createFilter } from 'vite';\n\nimport type { AST } from 'ember-template-recast';\nimport type { Plugin } from 'vite';\n\nconst GLIMMER_TEMPLATE_LANG = 'glimmer-template';\n\nexport interface SnippetExtractorOptions {\n  filter?: string | string[];\n}\n\nfunction cloneNode<T extends AST.Node>(node: T): T {\n  return parse(print(node)) as T;\n}\n\nfunction escapeSource(source: string): string {\n  return source\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;')\n    .replace(/\\n/g, '&#10;')\n    .replace(/\\{/g, '&#123;')\n    .replace(/\\}/g, '&#125;');\n}\n\nfunction extractCode(code: string): string {\n  let lines = code.split(/\\r?\\n/);\n\n  // Remove leading blank lines\n  while (lines.length > 0 && lines[0]!.trim() === '') {\n    lines.shift();\n  }\n\n  // Remove trailing blank lines\n  while (lines.length > 0 && lines[lines.length - 1]!.trim() === '') {\n    lines.pop();\n  }\n\n  if (lines.length === 0) {\n    return '';\n  }\n\n  const whitespace = lines[0]!.match(/^(\\s*)/)?.[1] ?? '';\n  if (whitespace) {\n    const regex = new RegExp(`^${whitespace}`);\n\n    lines = lines.map((line) => line.replace(regex, ''));\n  }\n\n  return escapeSource(lines.join('\\n'));\n}\n\nfunction markArguments(node: AST.Statement | AST.Template, blockName: string): void {\n  if (node.type === 'Template') {\n    for (const child of node.body) {\n      markArguments(child, blockName);\n    }\n\n    return;\n  }\n\n  if (node.type === 'ElementNode') {\n    for (const attrNode of node.attributes) {\n      if (attrNode.value.type !== 'MustacheStatement') {\n        continue;\n      }\n\n      const path = attrNode.value.path;\n\n      if (\n        path.type !== 'PathExpression' ||\n        path.head.type !== 'VarHead' ||\n        !path.original.startsWith(blockName)\n      ) {\n        continue;\n      }\n\n      const fullPath = path.tail.join('.');\n      const placeholder = `__SHOWCASE_ARG_${blockName}-${fullPath}__`;\n\n      attrNode.value = builders.mustache(placeholder);\n    }\n\n    for (const child of node.children) {\n      markArguments(child, blockName);\n    }\n  }\n}\n\nfunction walkAST(node: AST.Node): boolean {\n  let didChange = false;\n\n  if (node.type === 'Program') {\n    for (const child of node.body) {\n      didChange ||= walkAST(child);\n    }\n  }\n\n  if (node.type === 'ElementNode') {\n    if (node.tag === 'Section.Subsection') {\n      const exampleBlock = node.children.find(\n        (child) => child.type === 'ElementNode' && child.tag === ':example',\n      ) as AST.ElementNode | undefined;\n\n      if (exampleBlock) {\n        const blockName = exampleBlock.blockParams[0];\n        const clonedChildren = exampleBlock.children.map(cloneNode);\n\n        if (blockName) {\n          for (const child of clonedChildren) {\n            markArguments(child, blockName);\n          }\n        }\n\n        const rawSource = print(builders.program(clonedChildren));\n        const codeContent = extractCode(rawSource);\n        const sourceAttr = builders.attr('@sourceCode', builders.text(codeContent));\n        const langAttr = builders.attr('@sourceLanguage', builders.text(GLIMMER_TEMPLATE_LANG));\n\n        node.attributes.push(sourceAttr, langAttr);\n\n        didChange = true;\n      }\n    }\n\n    for (const child of node.children) {\n      didChange = walkAST(child) || didChange;\n    }\n  }\n\n  return didChange;\n}\n\nexport function extractCodeBlocks(options: SnippetExtractorOptions = {}): Plugin {\n  const glob = options.filter ?? ['**/*.gts', '**/*.gjs'];\n  const filter = createFilter(glob);\n\n  return {\n    name: 'ember-showcase-extract-code-blocks',\n    enforce: 'pre',\n\n    async transform(code, id) {\n      if (!filter(id)) {\n        return null;\n      }\n\n      const t = new Transformer(code);\n\n      await t.asyncMap((contents: string) => {\n        const ast = parse(contents);\n\n        let didChange = false;\n        for (const node of ast.body) {\n          didChange ||= walkAST(node);\n        }\n\n        if (didChange) {\n          return print(ast);\n        }\n\n        return contents;\n      });\n\n      return t.toString() as string;\n    },\n  };\n}\n"],"names":["GLIMMER_TEMPLATE_LANG","cloneNode","node","parse","print","escapeSource","source","replace","extractCode","code","lines","split","length","trim","shift","pop","whitespace","match","regex","RegExp","map","line","join","markArguments","blockName","type","child","body","attrNode","attributes","value","path","head","original","startsWith","fullPath","tail","placeholder","builders","mustache","children","walkAST","didChange","tag","exampleBlock","find","blockParams","clonedChildren","rawSource","program","codeContent","sourceAttr","attr","text","langAttr","push","extractCodeBlocks","options","glob","filter","createFilter","name","enforce","transform","id","t","Transformer","asyncMap","contents","ast","toString"],"mappings":"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"}