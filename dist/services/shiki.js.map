{"version":3,"file":"shiki.js","sources":["../../src/services/shiki.ts"],"sourcesContent":["import { assert } from '@ember/debug';\nimport Service from '@ember/service';\nimport { getOwnConfig } from '@embroider/macros';\nimport { tracked } from '@glimmer/tracking';\nimport { task } from 'ember-concurrency';\nimport { createOnigurumaEngine, hastToHtml } from 'shiki';\nimport { createHighlighterCore } from 'shiki/core';\nimport { bundledLanguages } from 'shiki/langs';\nimport { bundledThemes } from 'shiki/themes';\n\nimport type { Element } from 'hast';\nimport type { BundledLanguage, BundledTheme, CodeToHastOptions, HighlighterCore } from 'shiki';\n\nexport type AllowedLanguage = BundledLanguage | 'glimmer-template' | 'plaintext';\n\nconst lightThemes = getOwnConfig()?.themes?.light ?? ['github-light'];\nconst darkThemes = getOwnConfig()?.themes?.dark ?? ['github-dark'];\nconst languages = getOwnConfig()?.languages ?? [\n  'typescript',\n  'javascript',\n  'json',\n  'css',\n  'html',\n  'glimmer-js',\n  'glimmer-ts',\n];\n\nassert(\n  'Light themes must be a non-empty array',\n  Array.isArray(lightThemes) && lightThemes.length > 0,\n);\nassert('Dark themes must be a non-empty array', Array.isArray(darkThemes) && darkThemes.length > 0);\nassert('Languages must be a non-empty array', Array.isArray(languages) && languages.length > 0);\n\nexport interface ShikiServiceOptions {\n  defaultLightTheme?: BundledTheme;\n  defaultDarkTheme?: BundledTheme;\n  cssVariablePrefix?: string;\n}\n\nexport interface HighlightedCode {\n  html: string;\n  isRendered: boolean;\n  background: {\n    light: string;\n    dark: string;\n  };\n}\n\nconst DEFAULT_CSS_VARIABLE_PREFIX = '--shiki-';\n\nexport default class ShikiService extends Service {\n  highlighter?: HighlighterCore;\n\n  @tracked\n  loadedThemes?: BundledTheme[];\n\n  @tracked\n  declare defaultLightTheme: BundledTheme;\n\n  @tracked\n  declare defaultDarkTheme: BundledTheme;\n\n  @tracked\n  cssVariablePrefix = DEFAULT_CSS_VARIABLE_PREFIX;\n\n  initialize = task(async (options: ShikiServiceOptions = {}) => {\n    if (this.highlighter) {\n      this.highlighter.dispose();\n    }\n\n    this.loadedThemes = [];\n    const allThemes = [...lightThemes, ...darkThemes];\n\n    this.defaultLightTheme = options.defaultLightTheme ?? lightThemes[0]!;\n    this.defaultDarkTheme = options.defaultDarkTheme ?? darkThemes[0]!;\n\n    const langPromises = languages.map((lang) => bundledLanguages[lang]());\n    const themePromises = allThemes.map((theme) => bundledThemes[theme]());\n\n    this.highlighter = await createHighlighterCore({\n      langs: await Promise.all(langPromises),\n      themes: await Promise.all(themePromises),\n      engine: createOnigurumaEngine(await import('shiki/wasm')),\n    });\n\n    this.loadedThemes = allThemes;\n    this.cssVariablePrefix = options.cssVariablePrefix ?? DEFAULT_CSS_VARIABLE_PREFIX;\n  });\n\n  highlight(\n    code: string,\n    lang: AllowedLanguage,\n    options?: Partial<CodeToHastOptions>,\n  ): HighlightedCode {\n    const { highlighter, cssVariablePrefix } = this;\n    if (!highlighter) {\n      return {\n        isRendered: false,\n        html: code,\n        background: {\n          light: 'transparent',\n          dark: 'transparent',\n        },\n      };\n    }\n\n    let lightTheme: BundledTheme | 'none' = this.defaultLightTheme;\n    let darkTheme: BundledTheme | 'none' = this.defaultDarkTheme;\n\n    if (!this.loadedThemes?.includes(lightTheme)) {\n      lightTheme = 'none';\n    }\n\n    if (!this.loadedThemes?.includes(darkTheme)) {\n      darkTheme = 'none';\n    }\n\n    if (lang === 'glimmer-template') {\n      options ??= {};\n\n      lang = 'glimmer-js';\n      options.grammarContextCode = '<template>';\n    }\n\n    const hast = highlighter.codeToHast(code, {\n      cssVariablePrefix,\n      defaultColor: false,\n      lang,\n      themes: {\n        light: lightTheme,\n        dark: darkTheme,\n      },\n      ...options,\n    });\n\n    const root = hast.children[0] as Element;\n    const style = (root.properties?.['style'] as string) ?? '';\n    root.properties['class'] += ' code-block';\n\n    const html = hastToHtml(hast);\n\n    return {\n      isRendered: true,\n      html,\n      background: {\n        light: this.extractBackgroundColor(style, 'light'),\n        dark: this.extractBackgroundColor(style, 'dark'),\n      },\n    };\n  }\n\n  extractBackgroundColor(style: string, theme: 'light' | 'dark'): string {\n    const match = new RegExp(`${this.cssVariablePrefix}${theme}-bg:([^;]+)`).exec(style);\n\n    return match?.[1] ?? 'transparent';\n  }\n}\n"],"names":["lightThemes","getOwnConfig","themes","light","darkThemes","dark","languages","assert","Array","isArray","length","DEFAULT_CSS_VARIABLE_PREFIX","ShikiService","Service","highlighter","g","prototype","tracked","i","initialize","_buildTask","context","generator","options","dispose","loadedThemes","allThemes","defaultLightTheme","defaultDarkTheme","langPromises","map","lang","bundledLanguages","themePromises","theme","bundledThemes","createHighlighterCore","langs","Promise","all","engine","createOnigurumaEngine","cssVariablePrefix","highlight","code","isRendered","html","background","lightTheme","darkTheme","includes","grammarContextCode","hast","codeToHast","defaultColor","root","children","style","properties","hastToHtml","extractBackgroundColor","match","RegExp","exec"],"mappings":"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"}