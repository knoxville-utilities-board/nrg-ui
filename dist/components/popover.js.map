{"version":3,"file":"popover.js","sources":["../../src/components/popover.gts"],"sourcesContent":["import { registerDestructor } from '@ember/destroyable';\nimport { concat, hash } from '@ember/helper';\nimport { arrow, autoUpdate, computePosition, flip, offset, size } from '@floating-ui/dom';\nimport Component from '@glimmer/component';\nimport { tracked } from '@glimmer/tracking';\nimport { restartableTask, timeout } from 'ember-concurrency';\nimport { modifier } from 'ember-modifier';\n\nimport { classes } from '../helpers/classes.ts';\nimport onInsert from '../modifiers/on-insert.ts';\nimport { getRemValue } from '../utils/dom.ts';\n\nimport type { TOC } from '@ember/component/template-only';\nimport type Owner from '@ember/owner';\nimport type { Alignment, Placement, Side } from '@floating-ui/dom';\nimport type { ComponentLike } from '@glint/template';\n\nexport interface PopoverVisibility {\n  isShown: boolean;\n  toggle: (evt: Event) => Promise<void>;\n  show: (evtOrInput: HTMLInputElement | Event) => Promise<void>;\n  hide: () => Promise<void>;\n}\n\nexport interface HeaderSignature {\n  Element: HTMLHeadingElement;\n  Blocks: {\n    default: [];\n  };\n}\n\nconst Header: TOC<HeaderSignature> = <template>\n  <h3 class=\"popover-header\" ...attributes>\n    {{yield}}\n  </h3>\n</template>;\n\nexport interface BodySignature {\n  Element: HTMLDivElement;\n  Blocks: {\n    default: [];\n  };\n}\n\nconst Body: TOC<BodySignature> = <template>\n  <div class=\"popover-body\" ...attributes>\n    {{yield}}\n  </div>\n</template>;\n\nexport type Direction = 'top' | 'end' | 'bottom' | 'start';\n\nexport interface PopoverSignature {\n  Element: HTMLDivElement;\n  Args: {\n    alignment?: Alignment;\n    arrow?: boolean;\n    controlElement?: HTMLElement;\n    delay?: number;\n    flip?: boolean;\n    fullWidth?: boolean;\n    offset?: string | number;\n    side?: Direction;\n\n    onShow?: () => unknown;\n    onHide?: () => unknown;\n  };\n  Blocks: {\n    control: [PopoverVisibility];\n    content: [\n      {\n        Header: ComponentLike<HeaderSignature>;\n        Body: ComponentLike<BodySignature>;\n      },\n      PopoverVisibility,\n    ];\n  };\n}\n\nconst SIDE_TRANSLATION = {\n  top: 'top',\n  end: 'right',\n  bottom: 'bottom',\n  start: 'left',\n} as const as Record<Direction, Side>;\n\nconst ARROW_SIDE = {\n  top: 'bottom',\n  end: 'left',\n  bottom: 'top',\n  start: 'right',\n} as const as Record<Direction, Side>;\n\nexport default class Popover extends Component<PopoverSignature> {\n  declare _control: HTMLElement | null;\n  declare popover: HTMLElement | null;\n  declare arrow: HTMLElement | null;\n\n  declare cleanupAutoUpdate: (() => void) | null;\n\n  id = `popover-${crypto.randomUUID()}`;\n\n  @tracked\n  adjustedSide: Direction = 'bottom';\n\n  @tracked\n  isShown = false;\n\n  constructor(owner: Owner, args: PopoverSignature['Args']) {\n    super(owner, args);\n\n    registerDestructor(this, () => {\n      if (this.cleanupAutoUpdate) {\n        this.cleanupAutoUpdate();\n        this.cleanupAutoUpdate = null;\n      }\n    });\n  }\n\n  get control() {\n    return this.args.controlElement ?? this._control;\n  }\n\n  get hasArrow() {\n    return this.args.arrow ?? true;\n  }\n\n  get middleware() {\n    const middleware = [offset(this.offset)];\n\n    if (this.args.flip) {\n      middleware.push(flip());\n    }\n\n    if (this.hasArrow) {\n      middleware.push(arrow({ element: this.arrow! }));\n    }\n\n    if (this.args.fullWidth) {\n      const expandWidth = size({\n        apply({ rects, elements }) {\n          Object.assign(elements.floating.style, {\n            minWidth: `${rects.reference.width}px`,\n            maxWidth: `${rects.reference.width}px`,\n          });\n        },\n      });\n\n      middleware.push(expandWidth);\n    }\n\n    return middleware;\n  }\n\n  get offset() {\n    const defaultOffset = this.hasArrow ? getRemValue() / 2 : 0;\n    const { offset } = this.args;\n    const numOffset = typeof offset === 'number' ? offset : parseFloat(offset ?? '0');\n\n    return numOffset + defaultOffset;\n  }\n\n  get placement() {\n    let placement: Placement | Side = SIDE_TRANSLATION[this.side];\n    if (this.args.alignment) {\n      placement += `-${this.args.alignment}`;\n    }\n    return placement as Placement;\n  }\n\n  get side(): Direction {\n    return this.args.side ?? 'bottom';\n  }\n\n  hide = async () => {\n    this.triggerDisplay.cancelAll();\n\n    if (!this.isShown) {\n      return;\n    }\n\n    this.isShown = false;\n    await this.args.onHide?.();\n\n    if (this.cleanupAutoUpdate) {\n      this.cleanupAutoUpdate();\n      this.cleanupAutoUpdate = null;\n    }\n\n    this._control = null;\n  };\n\n  initPopover = (popover: HTMLElement) => {\n    this.popover = popover;\n  };\n\n  setArrow = (popover: HTMLElement) => {\n    this.arrow = popover;\n  };\n\n  show = async (evtOrInput: Event | HTMLInputElement) => {\n    if (this.isShown) {\n      return;\n    }\n\n    this.triggerDisplay.perform(evtOrInput);\n  };\n\n  showPopover = () => {\n    if (!this.control || !this.popover) {\n      return;\n    }\n\n    this.cleanupAutoUpdate?.();\n\n    this.cleanupAutoUpdate = autoUpdate(this.control, this.popover, this.updatePosition);\n  };\n\n  showPopoverModifier = modifier((element: unknown, positional: unknown[]) => {\n    // Entangle all arguments to ensure reactivity\n    positional.forEach(() => {});\n\n    this.showPopover();\n  });\n\n  updatePosition = async () => {\n    const { x, y, placement, middlewareData } = await computePosition(\n      this.control!,\n      this.popover!,\n      {\n        placement: this.placement,\n        middleware: this.middleware,\n      },\n    );\n\n    Object.assign(this.popover!.style, {\n      left: `${x}px`,\n      top: `${y}px`,\n    });\n\n    if (!this.hasArrow) {\n      return;\n    }\n\n    if (placement !== this.placement) {\n      this.adjustedSide = Object.keys(SIDE_TRANSLATION).find(\n        (side) => SIDE_TRANSLATION[side as Direction] === placement,\n      ) as Direction;\n    } else {\n      this.adjustedSide = this.side;\n    }\n\n    const { x: arrowX, y: arrowY } = middlewareData.arrow!;\n    const staticSide: string = ARROW_SIDE[placement.split('-')[0] as Direction]!;\n\n    Object.assign(this.arrow!.style, {\n      left: arrowX ? `${arrowX}px` : '',\n      top: arrowY ? `${arrowY}px` : '',\n      right: '',\n      bottom: '',\n      [staticSide]: 'calc(-1 * (0.5rem + var(--bs-popover-border-width)))',\n    });\n  };\n\n  toggle = async (evt: Event) => {\n    const action = this.isShown ? this.hide : this.show;\n\n    await action(evt);\n  };\n\n  triggerDisplay = restartableTask(async (evtOrInput: Event | HTMLInputElement) => {\n    const { currentTarget } = evtOrInput as Event;\n\n    if (this.args.delay) {\n      await timeout(this.args.delay);\n    }\n\n    this.isShown = true;\n\n    await this.args.onShow?.();\n\n    if (evtOrInput instanceof HTMLInputElement) {\n      this._control = evtOrInput;\n      this.showPopover();\n    } else if (evtOrInput instanceof Event && currentTarget instanceof HTMLElement) {\n      this._control = currentTarget;\n      this.showPopover();\n    }\n  });\n\n  <template>\n    {{#let\n      (hash isShown=this.isShown show=this.show hide=this.hide toggle=this.toggle)\n      as |visibility|\n    }}\n      {{yield visibility to=\"control\"}}\n      <div\n        id={{this.id}}\n        class={{classes\n          (unless this.isShown \"hidden\")\n          (concat \"popover bs-popover-\" this.adjustedSide)\n          \"overflow-x-auto\"\n        }}\n        {{onInsert this.initPopover}}\n        {{this.showPopoverModifier @alignment @arrow @controlElement @offset @side}}\n        ...attributes\n      >\n        {{#if (has-block-params \"content\")}}\n          {{yield (hash Header=(component Header) Body=(component Body)) visibility to=\"content\"}}\n        {{else}}\n          {{! @glint-expect-error - If there are no block params, we don't need to yield anything to the block }}\n          {{yield to=\"content\"}}\n        {{/if}}\n        {{#if this.hasArrow}}\n          <div class=\"popover-arrow\" {{onInsert this.setArrow}}></div>\n        {{/if}}\n      </div>\n    {{/let}}\n  </template>\n}\n"],"names":["Header","setComponentTemplate","precompileTemplate","strictMode","templateOnly","Body","SIDE_TRANSLATION","top","end","bottom","start","ARROW_SIDE","Popover","Component","id","crypto","randomUUID","g","prototype","tracked","i","constructor","owner","args","registerDestructor","cleanupAutoUpdate","control","controlElement","_control","hasArrow","arrow","middleware","offset","flip","push","element","fullWidth","expandWidth","size","apply","rects","elements","Object","assign","floating","style","minWidth","reference","width","maxWidth","defaultOffset","getRemValue","numOffset","parseFloat","placement","side","alignment","hide","triggerDisplay","cancelAll","isShown","onHide","initPopover","popover","setArrow","show","evtOrInput","perform","showPopover","autoUpdate","updatePosition","showPopoverModifier","modifier","positional","forEach","x","y","middlewareData","computePosition","left","adjustedSide","keys","find","arrowX","arrowY","staticSide","split","right","toggle","evt","action","_buildTask","context","generator","currentTarget","delay","timeout","onShow","HTMLInputElement","Event","HTMLElement","scope","hash","classes","concat","onInsert"],"mappings":"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"}