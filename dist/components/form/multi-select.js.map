{"version":3,"file":"multi-select.js","sources":["../../../src/components/form/multi-select.gts"],"sourcesContent":["import { fn, hash } from '@ember/helper';\nimport { on } from '@ember/modifier';\nimport { get } from '@ember/object';\nimport { service } from '@ember/service';\nimport { cached, tracked } from '@glimmer/tracking';\nimport { t, tKey } from 'ember-intl';\nimport { scheduleTask } from 'ember-lifeline';\nimport { TrackedArray } from 'tracked-built-ins';\n\nimport BoundValue from './bound-value.ts';\nimport Select from './select.gts';\nimport { bind } from '../../helpers/bind.ts';\n\nimport type { BoundValueSignature, DropdownSignature, Optional } from '../../index.ts';\nimport type { PopoverVisibility } from '../popover.gts';\nimport type { FieldOptions } from './field.gts';\nimport type { TOC } from '@ember/component/template-only';\nimport type Owner from '@ember/owner';\nimport type { WithBoundArgs } from '@glint/template';\nimport type { IntlService } from 'ember-intl';\n\ndeclare type SelectOption<T> = {\n  label: string;\n  value: T;\n  raw?: T;\n  selected?: boolean;\n};\n\ndeclare interface RemoveButtonSignature {\n  Element: HTMLSpanElement;\n  Args: {\n    disabled?: boolean;\n    onClick: (evt: MouseEvent) => unknown;\n  };\n}\n\nconst RemoveButton: TOC<RemoveButtonSignature> = <template>\n  <button\n    aria-label={{t \"nrg.base.remove\"}}\n    class=\"btn-close btn-close-white ms-2\"\n    disabled={{@disabled}}\n    type=\"button\"\n    {{on \"click\" @onClick}}\n  />\n</template>;\n\nexport type MultiSelectSignature<T> = BoundValueSignature<\n  {\n    Element: HTMLButtonElement;\n    Args: {\n      closeOnSelect?: boolean;\n      defaultText?: string;\n      defaultTextKey?: string;\n      displayPath?: string;\n      loading?: boolean;\n      noOptionsText?: string;\n      noOptionsTextKey?: string;\n      options?: readonly T[];\n      scrollable?: boolean;\n      serializationPath?: string | null;\n\n      fieldOptions?: FieldOptions;\n\n      onAdd?: (value: T) => unknown;\n      onRemove?: (value: T) => unknown;\n      onShow?: () => unknown | Promise<unknown>;\n      onHide?: () => unknown | Promise<unknown>;\n    };\n    Blocks: {\n      control?: [PopoverVisibility];\n      display?: [T[]];\n      option?: [T | undefined];\n      selection?: [\n        {\n          value: T | undefined;\n          Remove: WithBoundArgs<typeof RemoveButton, 'disabled' | 'onClick'>;\n        },\n      ];\n      empty?: [];\n      menu?: DropdownSignature['Blocks']['menu'];\n    };\n  },\n  T[]\n>;\n\nexport default class MultiSelect<T> extends BoundValue<MultiSelectSignature<T>, T[]> {\n  @service\n  declare intl: IntlService;\n\n  @tracked\n  lastSelection: Optional<SelectOption<T>> = null;\n\n  self: Record<'value', Optional<T[]>> = this;\n  TypedSelect = Select;\n\n  constructor(owner: Owner, args: MultiSelectSignature<T>['Args']) {\n    super(owner, args);\n\n    if (!(this.value instanceof TrackedArray)) {\n      scheduleTask(this, 'actions', () => {\n        this.onChange(new TrackedArray(this.value ?? []));\n      });\n    }\n  }\n\n  get defaultText() {\n    return (\n      this.args.defaultText ??\n      this.intl.t(this.args.defaultTextKey ?? tKey('nrg.multi-select.defaultText'))\n    );\n  }\n\n  get noOptionsText() {\n    return (\n      this.args.noOptionsText ??\n      this.intl.t(this.args.noOptionsTextKey ?? tKey('nrg.multi-select.noOptions'))\n    );\n  }\n\n  get closeOnSelect() {\n    return this.args.closeOnSelect ?? false;\n  }\n\n  @cached\n  get internalOptions(): SelectOption<T>[] {\n    const { value: selections } = this;\n\n    if (!this.args.options) {\n      return [];\n    }\n\n    return this.args.options.map((option) => {\n      if (typeof option !== 'object') {\n        return {\n          raw: option,\n          label: option as string,\n          value: option,\n          selected: selections!.includes(option),\n        };\n      }\n\n      const label = get(option, this.args.displayPath ?? 'label') as string;\n      let value: T = option;\n\n      // null serializationPath results in value being the raw option\n      if (this.args.serializationPath !== null) {\n        value = get(option, this.args.serializationPath ?? 'value') as T;\n      }\n\n      return {\n        raw: option,\n        label,\n        value,\n      };\n    });\n  }\n\n  @cached\n  get selectedOptions(): SelectOption<T>[] {\n    const { internalOptions, value } = this;\n\n    return value!.map(\n      (selectedValue) => internalOptions.find((option) => option.value === selectedValue)!,\n    );\n  }\n\n  @cached\n  get availableOptions(): SelectOption<T>[] {\n    return this.internalOptions.filter((option) => !this.value!.includes(option.value));\n  }\n\n  addItem = (option: Optional<SelectOption<T>>) => {\n    const { value: currentValue } = this;\n    const { value } = option!;\n\n    this.args.onAdd?.(value);\n    currentValue!.push(value);\n\n    this.onChange(currentValue);\n    this.lastSelection = null;\n  };\n\n  removeItem = (option: Optional<SelectOption<T>>, index: number) => {\n    const { value: currentValue } = this;\n    const { value } = option!;\n\n    this.args.onRemove?.(value);\n    currentValue!.splice(index, 1);\n\n    this.onChange(currentValue);\n  };\n\n  <template>\n    <div class=\"card multi-select border-0\">\n      <Select\n        @binding={{bind this.self \"lastSelection\"}}\n        @closeOnSelect={{this.closeOnSelect}}\n        @defaultTextKey=\"nrg.multi-select.defaultText\"\n        @fieldOptions={{hash\n          describedBy=@fieldOptions.describedBy\n          disabled=@fieldOptions.disabled\n          id=@fieldOptions.id\n          isInvalid=@fieldOptions.isInvalid\n          isWarning=@fieldOptions.isWarning\n          required=@fieldOptions.required\n        }}\n        @loading={{@loading}}\n        @noOptionsText={{@noOptionsText}}\n        @noOptionsTextKey={{@noOptionsTextKey}}\n        @options={{this.availableOptions}}\n        @scrollable={{@scrollable}}\n        @onChange={{this.addItem}}\n        ...attributes\n        @serializationPath={{null}}\n      >\n        <:empty>\n          {{#if this.value.length}}\n            {{#if (has-block \"display\")}}\n              {{yield this.value to=\"display\"}}\n            {{else}}\n              {{#each this.selectedOptions as |option i|}}\n                {{#if (has-block \"selection\")}}\n                  {{yield\n                    (hash\n                      value=option.raw\n                      Remove=(component\n                        RemoveButton\n                        disabled=@fieldOptions.disabled\n                        onClick=(fn this.removeItem option i)\n                      )\n                    )\n                    to=\"selection\"\n                  }}\n                {{else}}\n                  <span class=\"badge text-bg-secondary d-inline-flex align-items-center\">\n                    {{option.label}}\n                    <RemoveButton\n                      @disabled={{@fieldOptions.disabled}}\n                      @onClick={{fn this.removeItem option i}}\n                    />\n                  </span>\n                {{/if}}\n              {{/each}}\n            {{/if}}\n          {{else}}\n            {{#if (has-block \"empty\")}}\n              {{yield to=\"empty\"}}\n            {{else}}\n              {{this.defaultText}}\n            {{/if}}\n          {{/if}}\n        </:empty>\n        <:option as |option|>\n          {{#if (has-block \"option\")}}\n            {{yield option.raw to=\"option\"}}\n          {{else}}\n            {{option.label}}\n          {{/if}}\n        </:option>\n        <:menu as |Menu|>\n          {{#if (has-block \"menu\")}}\n            {{yield Menu to=\"menu\"}}\n          {{/if}}\n        </:menu>\n      </Select>\n    </div>\n  </template>\n}\n"],"names":["RemoveButton","setComponentTemplate","precompileTemplate","strictMode","scope","t","on","templateOnly","MultiSelect","BoundValue","g","prototype","service","i","tracked","self","TypedSelect","Select","constructor","owner","args","value","TrackedArray","scheduleTask","onChange","defaultText","intl","defaultTextKey","tKey","noOptionsText","noOptionsTextKey","closeOnSelect","internalOptions","selections","options","map","option","raw","label","selected","includes","get","displayPath","serializationPath","n","cached","selectedOptions","selectedValue","find","availableOptions","filter","addItem","currentValue","onAdd","push","lastSelection","removeItem","index","onRemove","splice","bind","hash","fn"],"mappings":"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"}