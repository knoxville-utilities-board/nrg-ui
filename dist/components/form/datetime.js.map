{"version":3,"file":"datetime.js","sources":["../../../src/components/form/datetime.gts"],"sourcesContent":["import { hash } from '@ember/helper';\nimport { on } from '@ember/modifier';\nimport { action } from '@ember/object';\nimport { tracked } from '@glimmer/tracking';\nimport dayjs from 'dayjs';\n\nimport DatetimeCalendar from './-private/calendar.gts';\nimport BoundValue from './bound-value.ts';\nimport TextInput from './text-input.gts';\nimport { bind } from '../../helpers/bind.ts';\nimport onClickOutside from '../../modifiers/on-click-outside.ts';\n\nimport type { FieldOptions } from './field.gts';\nimport type { BoundValueSignature, IconType } from '../../index.ts';\nimport type { Dayjs, OpUnitType } from 'dayjs';\n\nconst defaultDateFormat = 'LL';\nconst defaultTimeFormat = 'LT';\n\nexport type DatetimeSignature = BoundValueSignature<\n  {\n    Element: HTMLDivElement;\n    Args: {\n      allowMinuteSelection?: boolean;\n      dateFormat?: string;\n      maxDate?: Date | Dayjs;\n      minDate?: Date | Dayjs;\n      parseFormat?: string | string[];\n      placeholder?: string;\n      readonly?: boolean;\n      showNowShortcut?: boolean;\n      timeFormat?: string;\n      type?: 'datetime' | 'date' | 'time';\n\n      // Required by form fields\n      basic?: boolean;\n      fieldOptions?: FieldOptions;\n\n      _class?: string;\n\n      isDateDisabled?: (date: Date, precision?: OpUnitType) => boolean;\n\n      onHide?: () => void;\n      onShow?: () => void;\n    };\n    Blocks: {\n      default: [];\n    };\n  },\n  Date\n>;\n\nexport default class Datetime extends BoundValue<DatetimeSignature, Date> {\n  self: Record<'displayValue', string> = this;\n\n  @tracked\n  isFocused = false;\n\n  @tracked\n  inputValue = '';\n\n  get dateFormat() {\n    return this.args.dateFormat ?? defaultDateFormat;\n  }\n\n  get timeFormat() {\n    return this.args.timeFormat ?? defaultTimeFormat;\n  }\n\n  get type() {\n    return this.args.type ?? 'date'; // 'datetime', 'date', 'time'\n  }\n\n  get showNowShortcut() {\n    return this.args.showNowShortcut !== false;\n  }\n\n  get icon() {\n    let icon: IconType = 'bi-calendar-fill';\n    if (this.type === 'time') {\n      icon = 'bi-clock-fill';\n    }\n    return icon;\n  }\n\n  get displayFormat() {\n    if (this.type === 'datetime') {\n      return `${this.dateFormat} ${this.timeFormat}`;\n    } else if (this.type === 'date') {\n      return this.dateFormat;\n    }\n    return this.timeFormat;\n  }\n\n  get displayValue() {\n    if (this.isFocused && this.inputValue) {\n      return this.inputValue;\n    }\n    if (!this.value) {\n      return '';\n    }\n    return dayjs(this.value).format(this.displayFormat);\n  }\n\n  set displayValue(value) {\n    if (this.isFocused) {\n      this.inputValue = value;\n      return;\n    }\n    const newValue = dayjs(value, this.displayFormat);\n    if (!newValue.isValid()) {\n      return;\n    }\n\n    if (newValue.isSame(this.value, 'minute')) {\n      return;\n    }\n    this.onDateSelect(newValue.toDate());\n  }\n\n  get parseFormats() {\n    if (this.args.parseFormat) {\n      return this.args.parseFormat;\n    }\n    return [this.displayFormat];\n  }\n\n  get defaultValue() {\n    if (this.args.defaultValue !== undefined) {\n      return this.args.defaultValue ? dayjs(this.args.defaultValue).toDate() : null;\n    }\n\n    return new Date();\n  }\n\n  @action\n  onBlur() {\n    if (!this.isFocused) {\n      return;\n    }\n    const { inputValue } = this;\n    this.isFocused = false;\n    if (inputValue) {\n      let newValue = dayjs(inputValue, this.parseFormats);\n      if (!newValue.isValid()) {\n        newValue = dayjs(inputValue);\n      }\n      if (newValue.isValid()) {\n        this.onDateSelect(newValue.toDate());\n      }\n\n      this.inputValue = '';\n    }\n    this.args.onHide?.();\n  }\n\n  @action\n  onFocus(evt: FocusEvent) {\n    evt.preventDefault();\n    evt.stopPropagation();\n\n    if (this.isFocused || this.args.fieldOptions?.disabled || this.args.readonly) {\n      return;\n    }\n\n    this.isFocused = true;\n\n    const target = evt.currentTarget as HTMLElement;\n    const focusTarget = target.querySelector('input') as HTMLInputElement;\n\n    focusTarget?.focus();\n    this.args.onShow?.();\n  }\n\n  @action\n  onDateSelect(value: Date) {\n    this.onChange(value);\n  }\n\n  <template>\n    <div\n      class=\"calendar input-group\"\n      role=\"button\"\n      {{on \"click\" this.onFocus}}\n      {{onClickOutside this.onBlur}}\n      ...attributes\n    >\n      {{#unless @basic}}\n        <span class=\"input-group-text\">\n          <i class=\"{{this.icon}} text-secondary\" />\n        </span>\n      {{/unless}}\n      {{#unless (has-block)}}\n        <TextInput\n          class=\"border-start-0 rounded-end\"\n          placeholder={{@placeholder}}\n          @basic={{@basic}}\n          @binding={{bind this.self \"displayValue\"}}\n          @fieldOptions={{hash\n            describedBy=@fieldOptions.describedBy\n            disabled=@fieldOptions.disabled\n            id=@fieldOptions.id\n            isInvalid=@fieldOptions.isInvalid\n            isWarning=@fieldOptions.isWarning\n            required=@fieldOptions.required\n          }}\n          @readonly={{@readonly}}\n        />\n      {{/unless}}\n      {{yield}}\n      {{#if this.isFocused}}\n        <DatetimeCalendar\n          @minDate={{@minDate}}\n          @maxDate={{@maxDate}}\n          @type={{this.type}}\n          @value={{this.value}}\n          @showNowShortcut={{this.showNowShortcut}}\n          @isDateDisabled={{@isDateDisabled}}\n          @allowMinuteSelection={{@allowMinuteSelection}}\n          @onSelect={{this.onDateSelect}}\n          @onClose={{this.onBlur}}\n        />\n      {{/if}}\n    </div>\n  </template>\n}\n"],"names":["defaultDateFormat","defaultTimeFormat","Datetime","BoundValue","self","g","prototype","tracked","i","dateFormat","args","timeFormat","type","showNowShortcut","icon","displayFormat","displayValue","isFocused","inputValue","value","dayjs","format","newValue","isValid","isSame","onDateSelect","toDate","parseFormats","parseFormat","defaultValue","undefined","Date","onBlur","onHide","n","action","onFocus","evt","preventDefault","stopPropagation","fieldOptions","disabled","readonly","target","currentTarget","focusTarget","querySelector","focus","onShow","onChange","setComponentTemplate","precompileTemplate","strictMode","scope","on","onClickOutside","TextInput","bind","hash","DatetimeCalendar"],"mappings":"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"}