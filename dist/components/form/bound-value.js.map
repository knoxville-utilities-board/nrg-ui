{"version":3,"file":"bound-value.js","sources":["../../../src/components/form/bound-value.ts"],"sourcesContent":["import { assert } from '@ember/debug';\nimport { action, get, set } from '@ember/object';\nimport Component from '@glimmer/component';\nimport { runTask, scheduleTask } from 'ember-lifeline';\n\nimport { ensurePathExists } from '../../utils/ensure-path-exists.ts';\n\nimport type { FieldOptions } from './field.gts';\nimport type { Binding, Optional } from '../../index.ts';\nimport type Owner from '@ember/owner';\n\ntype AllowChangeFn<T> = (newValue: T, oldValue: T) => boolean;\n\nexport type BoundValueSignature<Signature, Type> = {\n  Args: {\n    binding?: Binding;\n\n    defaultValue?: Type;\n    useDefaultValue?: boolean;\n\n    fieldOptions?: FieldOptions;\n\n    allowChange?: AllowChangeFn<Optional<Type>>;\n    initBinding?: (binding: Binding) => void;\n    onChange?: (value: Optional<Type>, ...args: unknown[]) => void;\n  };\n} & Signature;\n\nexport default class BoundValue<Signature, T> extends Component<\n  BoundValueSignature<Signature, Optional<T>>\n> {\n  constructor(owner: Owner, args: BoundValueSignature<Signature, Optional<T>>['Args']) {\n    super(owner, args);\n\n    const { binding } = args;\n\n    assert(`You must provide a binding argument to ${this.constructor.name}`, binding);\n\n    const defaultValue = this.defaultValue;\n    const initialValue = this.value;\n    if (initialValue === undefined && defaultValue !== undefined && this.useDefaultValue) {\n      scheduleTask(this, 'actions', () => {\n        this.onChange(defaultValue);\n      });\n    }\n\n    runTask(this, () => {\n      const initFn = args.fieldOptions?.initBinding ?? args.initBinding;\n\n      initFn?.(binding);\n    });\n  }\n\n  get model() {\n    return this.args.binding!.model;\n  }\n\n  get valuePath() {\n    return this.args.binding!.valuePath;\n  }\n\n  get value(): Optional<T> {\n    return get(this.model, this.valuePath) as T;\n  }\n\n  set value(newValue: Optional<T>) {\n    ensurePathExists(this.model, this.valuePath);\n    set(this.model, this.valuePath, newValue);\n  }\n\n  get useDefaultValue(): boolean {\n    return this.args.useDefaultValue ?? false;\n  }\n\n  get defaultValue(): Optional<T> {\n    if (this.args.defaultValue !== undefined) {\n      return this.args.defaultValue;\n    }\n    return this.getDefaultValue?.() ?? null;\n  }\n\n  get allowChange(): AllowChangeFn<Optional<T>> {\n    if (this.args.allowChange) {\n      return this.args.allowChange;\n    }\n    return () => true;\n  }\n\n  getDefaultValue(): Optional<T> {\n    return null;\n  }\n\n  @action\n  onChange(newValue: Optional<T>, ...args: unknown[]) {\n    const currentValue = this.value;\n    if (!this.allowChange(newValue, currentValue)) {\n      return;\n    }\n\n    this.value = newValue;\n    this.args.onChange?.(newValue, ...args);\n  }\n}\n"],"names":["BoundValue","Component","constructor","owner","args","binding","assert","name","defaultValue","initialValue","value","undefined","useDefaultValue","scheduleTask","onChange","runTask","initFn","fieldOptions","initBinding","model","valuePath","get","newValue","ensurePathExists","set","getDefaultValue","allowChange","currentValue","n","prototype","action"],"mappings":"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"}