{"version":3,"file":"base.js","sources":["../../../src/validation/validators/base.ts"],"sourcesContent":["import ArrayProxy from '@ember/array/proxy';\nimport { assert } from '@ember/debug';\nimport { get } from '@ember/object';\nimport ObjectProxy from '@ember/object/proxy';\nimport { getOwner } from '@ember/owner';\nimport { cached } from '@glimmer/tracking';\n\nimport type { Binding } from '../../index.ts';\nimport type {\n  BaseOptions,\n  Computable,\n  TranslatableMessage,\n  ValidateFnResponse,\n  ValidationResult,\n  ValidatorImpl,\n} from '../types.ts';\nimport type { IntlService } from 'ember-intl';\n\nexport function isProxy(value: unknown): value is ObjectProxy | ArrayProxy<never> {\n  return value instanceof ObjectProxy || value instanceof ArrayProxy;\n}\n\nexport function unwrapProxy<T>(value: T): T {\n  if (isProxy(value)) {\n    return unwrapProxy(value.content as T);\n  }\n\n  return value;\n}\n\nexport default abstract class BaseValidator<\n  T,\n  Context extends object = Record<string, unknown>,\n  OptionsShape extends BaseOptions = BaseOptions,\n> implements ValidatorImpl<T, Context, OptionsShape> {\n  abstract validate(\n    this: BaseValidator<T, Context, OptionsShape>,\n    value: T,\n    options: OptionsShape,\n    context: Context,\n  ): ValidateFnResponse;\n  defaultOptions: Computable<Context, OptionsShape & BaseOptions> = {} as OptionsShape;\n\n  readonly owner;\n  readonly binding: Binding;\n  readonly options: Computable<Context, OptionsShape & BaseOptions>;\n  readonly context: Context;\n\n  constructor(\n    binding: Binding,\n    options: Computable<Context, OptionsShape & BaseOptions>,\n    context?: Context,\n  ) {\n    this.binding = binding;\n    this.options = options;\n    this.context = context ?? (binding.model as Context);\n\n    assert(`You must provide a binding argument to ${this.constructor.name}`, binding);\n\n    assert(\n      'BaseValidator requires the `validate` function to be implemented by subclasses',\n      typeof this.validate === 'function',\n    );\n\n    const owner = getOwner(this.context);\n    assert(\n      'The `context` or `model` must be have an owner. Usually this means the `context` or `model` is an EmberObject or GlimmerComponent, but this can be manually set up with `setOwner`',\n      owner !== undefined,\n    );\n\n    this.owner = owner;\n  }\n\n  get intl() {\n    return this.owner.lookup('service:intl') as IntlService;\n  }\n\n  get value(): T {\n    const { model, valuePath } = this.binding;\n    const value = get(model, valuePath) as T;\n\n    return unwrapProxy(value);\n  }\n\n  @cached\n  get result(): ValidationResult {\n    const { context, options, validate, value } = this;\n    const computedOptions = this.computeOptions(options);\n\n    if (computedOptions.disabled) {\n      return { isValid: true };\n    }\n\n    const response = validate.apply(this, [value, computedOptions, context]);\n\n    return this.coalesceResponse(response, computedOptions);\n  }\n\n  coalesceResponse(response: ValidateFnResponse, options: OptionsShape): ValidationResult {\n    let isValid = false;\n    let isWarning = options.isWarning;\n    let message = options.message;\n\n    if (typeof response === 'boolean') {\n      isValid = response;\n    } else if (typeof response === 'string') {\n      message = response;\n    } else {\n      isValid = response.isValid ?? isValid;\n      isWarning ??= response.isWarning ?? isWarning;\n    }\n\n    isWarning ??= false;\n\n    if (options.key) {\n      const translationOptions = { ...options };\n      if (typeof response === 'object') {\n        Object.assign(translationOptions, response);\n      }\n\n      message = this.translateMessage({\n        ...translationOptions,\n        key: options.key,\n      });\n    } else if (options.message) {\n      message = options.message;\n    } else if (typeof response === 'object') {\n      message = response.message;\n\n      if ('key' in response && response.key) {\n        message = this.translateMessage({ ...options, ...response });\n      }\n    }\n\n    if (isValid && !isWarning) {\n      message = undefined;\n    }\n\n    return { isValid, isWarning, message };\n  }\n\n  translateMessage(message: TranslatableMessage): string {\n    const { key, ...options } = message;\n\n    return this.intl.t(key, options);\n  }\n\n  computeOptions(options: Computable<Context, OptionsShape>) {\n    const { defaultOptions } = this;\n    const computed = {} as OptionsShape;\n\n    for (const key of Object.keys(options)) {\n      computed[key as keyof OptionsShape] = this.compute(options[key as keyof OptionsShape]);\n    }\n\n    for (const key of Object.keys(defaultOptions)) {\n      if (key in computed) {\n        continue;\n      }\n\n      const willOverrideMessage = key === 'key' && 'message' in computed;\n      const willOverrideKey = key === 'message' && 'key' in computed;\n      if (willOverrideMessage || willOverrideKey) {\n        continue;\n      }\n\n      computed[key as keyof OptionsShape] = this.compute(defaultOptions[key as keyof OptionsShape]);\n    }\n\n    return { ...computed };\n  }\n\n  compute<K extends keyof OptionsShape>(\n    value: Computable<Context, OptionsShape>[K],\n  ): OptionsShape[K] {\n    if (typeof value === 'function') {\n      return value.apply(this.context);\n    }\n\n    return value as OptionsShape[K];\n  }\n}\n"],"names":["isProxy","value","ObjectProxy","ArrayProxy","unwrapProxy","content","BaseValidator","defaultOptions","owner","binding","options","context","constructor","model","assert","name","validate","getOwner","undefined","intl","lookup","valuePath","get","result","computedOptions","computeOptions","disabled","isValid","response","apply","coalesceResponse","n","prototype","cached","isWarning","message","key","translationOptions","Object","assign","translateMessage","t","computed","keys","compute","willOverrideMessage","willOverrideKey"],"mappings":"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"}