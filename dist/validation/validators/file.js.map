{"version":3,"file":"file.js","sources":["../../../src/validation/validators/file.ts"],"sourcesContent":["import { assert } from '@ember/debug';\nimport { isEmpty } from '@ember/utils';\nimport { tKey } from 'ember-intl';\n\nimport BaseValidator from './base.ts';\n\nimport type { Binding } from '../../index.ts';\nimport type { BaseOptions, Computable, ValidateFnResponse } from '../types.ts';\n\nexport type FileOptions = {\n  /**\n   * Accepted file types, e.g. `['png', '.jpeg', 'image/*']`.\n   */\n  acceptedTypes?: string[];\n  /**\n   * Unaccepted file types, e.g. `['png', '.jpeg', 'image/*']`.\n   */\n  unacceptedTypes?: string[];\n} & BaseOptions;\n\nexport default class FileValidator<\n  Context extends object = Record<string, unknown>,\n> extends BaseValidator<File | File[], Context, FileOptions> {\n  defaultOptions = {};\n\n  constructor(binding: Binding, options: Computable<Context, FileOptions>, context?: Context) {\n    super(binding, options, context);\n\n    const { acceptedTypes, unacceptedTypes } = options;\n\n    if (isEmpty(acceptedTypes) && isEmpty(unacceptedTypes)) {\n      assert('FileValidator requires either `acceptedTypes` or `unacceptedTypes` to be provided');\n    }\n  }\n\n  validate(value: File | File[], options: FileOptions): ValidateFnResponse {\n    const { acceptedTypes, unacceptedTypes } = options;\n    if (!isEmpty(acceptedTypes)) {\n      if (Array.isArray(value)) {\n        for (const file of value) {\n          const acceptedResponse = this.checkFileIsAccepted(file, options);\n          if (acceptedResponse !== true) {\n            return acceptedResponse;\n          }\n        }\n      } else if (value instanceof File) {\n        const acceptedResponse = this.checkFileIsAccepted(value, options);\n        if (acceptedResponse !== true) {\n          return acceptedResponse;\n        }\n      }\n    }\n\n    if (!isEmpty(unacceptedTypes)) {\n      if (Array.isArray(value)) {\n        for (const file of value) {\n          const unacceptedResponse = this.checkFileIsUnaccepted(file, options);\n          if (unacceptedResponse !== true) {\n            return unacceptedResponse;\n          }\n        }\n      } else if (value instanceof File) {\n        const unacceptedResponse = this.checkFileIsUnaccepted(value, options);\n        if (unacceptedResponse !== true) {\n          return unacceptedResponse;\n        }\n      }\n    }\n    return true;\n  }\n\n  extractFileExtension(file: File): string {\n    return file.name.split('.').pop()?.toLowerCase() ?? '';\n  }\n\n  checkMimeType(type: string, fileType: string): boolean {\n    if (type.endsWith('/*')) {\n      return type.split('/')[0] === fileType.split('/')[0];\n    }\n    return type === fileType;\n  }\n\n  formatTypeValidations(types: string[]): string {\n    const typePrefixes = [];\n    for (const type of types) {\n      if (type.includes('/')) {\n        const prefix = type.split('/')[0];\n        typePrefixes.push(this.intl.t(`nrg.validation.file.${prefix}`));\n      } else {\n        typePrefixes.push(type);\n      }\n    }\n    return this.intl.formatList(typePrefixes, { style: 'narrow' });\n  }\n\n  fileIsAllowed(value: File, options: string[]): boolean {\n    const fileExtension = this.extractFileExtension(value);\n    return options.some(\n      (option) =>\n        option.split('.').pop()?.toLowerCase() === fileExtension ||\n        option.toLowerCase() === fileExtension ||\n        this.checkMimeType(option, value.type),\n    );\n  }\n\n  checkFileIsAccepted(value: File, options: FileOptions): ValidateFnResponse {\n    let acceptedTypes = options.acceptedTypes as string[];\n    const typeIsAllowed = this.fileIsAllowed(value, acceptedTypes);\n\n    if (!typeIsAllowed) {\n      for (const acceptedType of acceptedTypes) {\n        if (acceptedType.endsWith('/*')) {\n          acceptedTypes = acceptedTypes.filter((type) => type !== acceptedType);\n          acceptedTypes.push(acceptedType);\n        }\n      }\n      const types = this.formatTypeValidations(acceptedTypes);\n      return {\n        key: tKey('nrg.validation.file.acceptedTypes'),\n        types,\n      };\n    }\n    return true;\n  }\n\n  checkFileIsUnaccepted(value: File, options: FileOptions): ValidateFnResponse {\n    let unacceptedTypes = options.unacceptedTypes as string[];\n    const typeIsNotAllowed = this.fileIsAllowed(value, unacceptedTypes);\n\n    if (typeIsNotAllowed) {\n      for (const unacceptedType of unacceptedTypes) {\n        if (unacceptedType.endsWith('/*')) {\n          unacceptedTypes = unacceptedTypes.filter((type) => type !== unacceptedType);\n          unacceptedTypes.push(unacceptedType);\n        }\n      }\n      const types = this.formatTypeValidations(unacceptedTypes);\n      return {\n        key: tKey('nrg.validation.file.unacceptedTypes'),\n        types,\n      };\n    }\n\n    return true;\n  }\n}\n"],"names":["FileValidator","BaseValidator","defaultOptions","constructor","binding","options","context","acceptedTypes","unacceptedTypes","isEmpty","assert","validate","value","Array","isArray","file","acceptedResponse","checkFileIsAccepted","File","unacceptedResponse","checkFileIsUnaccepted","extractFileExtension","name","split","pop","toLowerCase","checkMimeType","type","fileType","endsWith","formatTypeValidations","types","typePrefixes","includes","prefix","push","intl","t","formatList","style","fileIsAllowed","fileExtension","some","option","typeIsAllowed","acceptedType","filter","key","tKey","typeIsNotAllowed","unacceptedType"],"mappings":"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"}